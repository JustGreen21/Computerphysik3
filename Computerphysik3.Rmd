---
title: 'Übung 03: Pandemieausbruch'
author: "Tobias Blesgen und Leonardo Thome"
date: "09.06.2021"
output:
  pdf_document: default
  html_document:
    df_print: paged
header-includes: 
 - \usepackage{amssymb}
 - \usepackage{amsmath}
 - \usepackage[ngerman]{babel}
 - \bibliographystyle{unsrtnat}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Im Folgenden wollen wir ein Simulierte Pandemieausbreitung von SARS-CoV-2 für verschiedene Parameter im SIR Modell betrachten.
Das SIR  Modell beschreibt den zeitlichen Verlauf mit folgendem Differentialgleichungssystem.
\begin{equation}
      S'(t) = -\frac{\beta}{N}S(t)I(t) -\Gamma(t)+ \delta V(t)
\end{equation}

\begin{equation}
      I'(t) = \frac{\beta}{N}S(t)I(t) -\alpha I(t)
\end{equation}

\begin{equation}
      R'(t) = \alpha I(t)
\end{equation}

\begin{equation}
      V'(t) = \Gamma(t) - \delta V(t)
\end{equation}

```{Rcpp}
#include<Rcpp.h>
#include<stdlib.h>
#include<stdio.h>
#include<vector>
#include<algorithm>

using namespace Rcpp;

typedef struct
{
    double S, I, R, V;
} Status;

typedef struct
{
    double alpha, beta, delta, N, gamma;
} Parameter;

template<typename T>
std::vector<T> slice(std::vector<T> const &v, int m, int n)
{
    auto first = v.cbegin() + m;
    auto last = v.cbegin() + n + 1;
 
    std::vector<T> vec(first, last);
    return vec;
}

void f(Status alterStatus, Parameter parameter, Status& neuerStatus){
  double Gamma = std::min(parameter.gamma,alterStatus.I);
    neuerStatus.V = Gamma - parameter.delta * alterStatus.V;
    neuerStatus.R = parameter.alpha * alterStatus.I;
    neuerStatus.I = parameter.beta * alterStatus.S * alterStatus.I/parameter.N
      - parameter.alpha * alterStatus.I;
    neuerStatus.S = -parameter.beta * alterStatus.S * alterStatus.I/parameter.N
      - Gamma + parameter.delta * alterStatus.V;
}

void rkSchritt(Status& status, Parameter parameter, double h){
    Status fStatus;
    f(status, parameter, fStatus);
    Status f2Status;
    Status gemischt = {.S = status.S + h*fStatus.S, .I = status.I
      + h*fStatus.I, .R = status.R + h*fStatus.R, .V = status.V + h*fStatus.V};
    f(gemischt, parameter, f2Status);
    status.V = status.V + h/2*(fStatus.V + f2Status.V);
    status.R = status.R + h/2*(fStatus.R + f2Status.R);
    status.S = status.S + h/2*(fStatus.S + f2Status.S);
    status.I = status.I + h/2*(fStatus.I + f2Status.I);
}

//[[Rcpp::export]]
Rcpp::List durchlauf(const int maxSchritte, const double h,
                            const double S, const double I, const double R,
                            const double V, const double alpha,
                            const double beta, const double delta,
                            const double N, const double gamma,
                            const double x0){
  // Array der Werte:
    std::vector<double> xValue(maxSchritte);
    std::vector<double> SValue(maxSchritte);
    std::vector<double> IValue(maxSchritte);
    std::vector<double> RValue(maxSchritte);
    std::vector<double> VValue(maxSchritte);
  // Quelltext
  Status status = {.S = S, .I = I, .R = R, .V = V};
  Parameter parameter = {.alpha = alpha, .beta = beta, .delta = delta, .N = N, .gamma = gamma};
  
    for (int i = 0; i < maxSchritte; i++){
      xValue[i] = x0 + i*h;
      SValue[i] = status.S;
      IValue[i] = status.I;
      RValue[i] = status.R;
      VValue[i] = status.V;
      rkSchritt(status, parameter, h);
      
      if(status.I < 1 && i>10){
          // Rückgabe für eine grafische Wiedergabe
          return List::create(Named("x") = slice(xValue,0,i), 
                              Named("S") = slice(SValue,0,i), 
                              Named("I") = slice(IValue,0,i),
                              Named("R") = slice(RValue,0,i), 
                              Named("V") = slice(VValue,0,i));
      }
    }
  // Rückgabe für eine grafische Wiedergabe
    return List::create(Named("x") = xValue, Named("S") = SValue, Named("I") = IValue, Named("R") = RValue, Named("V") = VValue);
}
```

```{r, echo=FALSE}
N = 8.3e7
S = N - 5000
I = 5000
R = 0
V = 0
R0 = 2.9
alpha = 1/7
beta = R0 * alpha
delta = 0
gamma = 0
h = 1
schritte = 1000
schutzlos1 = durchlauf(schritte, h, S, I, R, V, alpha, beta, delta, N, gamma, 0)
```

```{r, echo=FALSE}
plot(schutzlos1$x, schutzlos1$S, "l", xlab = "Tage", ylim=c(0, schutzlos1$S[1]),ylab = "Menschen", col = "dark blue")
lines(schutzlos1$x, schutzlos1$I, "l", col = "dark green")
lines(schutzlos1$x, schutzlos1$R, "l", col = "red")
legend(150,6e7,legend=c("S", "I","R"), col = c("dark blue", "green","red"), lty=1:1)
```

Betrachten wir nun die Kurven für $R_0 \in [1,20]$.

```{r, echo=FALSE}

pal <- colorRamp(c("red", "blue"))

N = 8.3e7
S = N - 5000
I = 5000
R = 0
V = 0
R0 = 15
alpha = 1/7
beta = R0 * alpha
delta = 0
gamma = 0
h = 0.01
schritte = 50000

schutzlos = durchlauf(schritte, h, S, I, R, V, alpha, beta, delta, N, gamma,0)
plot(schutzlos$x, schutzlos$I, "l", xlab = "Tage", ylim=c(0, 6.5e7), xlim=c(0,140), ylab = "erkrankte Menschen", col = rainbow(20)[R0])

range <- 1:20
nicht_infizierte <- 1:20 

for (R1 in range) {
  beta = R1 * alpha
  schutzlos = durchlauf(schritte, h, S, I, R, V, alpha, beta, delta, N, gamma,0)
  lines(schutzlos$x, schutzlos$I, "l", col = rainbow(20)[R1])
  nicht_infizierte[R1] = schutzlos$S[length(schutzlos$S)]
}

legend(100,5e7,legend=c("R0 = 1", "R0 = 7", "R0 = 14", "R0 = 20"), col = c(rainbow(20)[1], rainbow(20)[7], rainbow(20)[14], rainbow(20)[20]), lty=1:1)

print(range)
print(nicht_infizierte)

plot(1/range, nicht_infizierte/N,"l", xlab = "1/R0", ylab = "S/N")

```

### Mit Gegenmaßnahmen

Unter der Verwendung der Daten des RKI versuchen wir den COVID-19-Verlauf zu modellieren. Als Startwert wurden die Daten des 03.01.2021 \cite{januar} mit I = 349500, R = 1765666-I, V = 238809 verwendet. Desweiteren wurde $\gamma$ und $\mathrm{N}_0$ als Treppenfunktion mit den Werten
            $\gamma$          Tag        aktive Fälle      
Januar:     40665             3           349500
Februar:    49890             37          193200
März:       208569            71          127100
April:      323200            110         279400
Mai:        390904            142         167100

verwendet.

```{r, echo=FALSE}
N = 8.3e7
I = 349500
R = 1765666-I
V = 238809
S = N - I - R - V

alpha = 1/7
delta = 1/150

R0 <-c(5,1.2,1.2,1.2,1.2)
gamma <-c(40665,49890,208569,323200,390904)
tage <-c(3,37,71,110,142)
h = 1

schutz1 = durchlauf((tage[2]-tage[1])/h, h, S, I, R, V, alpha, R0[1] * alpha, delta, N, gamma[1], tage[1])

schutz2 = durchlauf((tage[3]-tage[2])/h, h, schutz1$S[length(schutz1$S)], 
                    schutz1$I[length(schutz1$I)], schutz1$R[length(schutz1$R)], 
                    schutz1$V[length(schutz1$V)], alpha, R0[2] * alpha, delta, N, gamma[2], tage[2])

schutz3 = durchlauf((tage[4]-tage[3])/h, h, schutz2$S[length(schutz2$S)], 
                    schutz2$I[length(schutz2$I)], schutz2$R[length(schutz2$R)], 
                    schutz2$V[length(schutz2$V)], alpha, R0[3] * alpha, delta, N, gamma[3], tage[3])

schutz4 = durchlauf((tage[5]-tage[4])/h, h, schutz3$S[length(schutz3$S)], 
                    schutz3$I[length(schutz3$I)], schutz3$R[length(schutz3$R)], 
                    schutz3$V[length(schutz3$V)], alpha, R0[4] * alpha, delta, N, gamma[4], tage[4])

schutz5 = durchlauf(500, h, schutz4$S[length(schutz4$S)], 
                    schutz4$I[length(schutz4$I)], schutz4$R[length(schutz4$R)], 
                    schutz4$V[length(schutz4$V)], alpha, R0[5] * alpha, delta, N, gamma[5], tage[5])

schutzx = append(schutz1$x, append(schutz2$x, append(schutz3$x, append(schutz4$x,schutz5$x) ) ) )
schutzI = append(schutz1$I, append(schutz2$I, append(schutz3$I, append(schutz4$I,schutz5$I) ) ) )


#Vergleich

```

```{r, echo=FALSE}
plot(schutzx, schutzI, "l", xlab = "Tage", ylab = "Menschen", col = "dark blue")

legend(150,6e7,legend=c("S", "I","R"), col = c("dark blue", "green","red"), lty=1:1)
```

\begin{thebibliography}{99}
\bibitem{januar} 
\textit{Täglicher Lagebericht des RKIzur Coronavirus-Krankheit-2019(COVID-19)}, Robert Koch Institut, \url{https://www.rki.de/DE/Content/InfAZ/N/Neuartiges_Coronavirus/Situationsberichte/Jan_2021/2021-01-03-de.pdf?__blob=publicationFile}, Stand: 24.05.2021.

\bibitem{februar} 
\textit{Täglicher Lagebericht des RKIzur Coronavirus-Krankheit-2019(COVID-19)}, Robert Koch Institut, \url{https://www.rki.de/DE/Content/InfAZ/N/Neuartiges_Coronavirus/Situationsberichte/Feb_2021/2021-02-06-de.pdf?__blob=publicationFile}, Stand: 24.05.2021.

\bibitem{maerz} 
\textit{Täglicher Lagebericht des RKIzur Coronavirus-Krankheit-2019(COVID-19)}, Robert Koch Institut, \url{https://www.rki.de/DE/Content/InfAZ/N/Neuartiges_Coronavirus/Situationsberichte/Maerz_2021/2021-03-12-de.pdf?__blob=publicationFile}, Stand: 24.05.2021.

\bibitem{april} 
\textit{Täglicher Lagebericht des RKIzur Coronavirus-Krankheit-2019(COVID-19)}, Robert Koch Institut, \url{https://www.rki.de/DE/Content/InfAZ/N/Neuartiges_Coronavirus/Situationsberichte/Apr_2021/2021-04-20-de.pdf?__blob=publicationFile}, Stand: 24.05.2021.

\bibitem{mai} 
\textit{Täglicher Lagebericht des RKIzur Coronavirus-Krankheit-2019(COVID-19)}, Robert Koch Institut, \url{https://www.rki.de/DE/Content/InfAZ/N/Neuartiges_Coronavirus/Situationsberichte/Mai_2021/2021-05-22-de.pdf?__blob=publicationFile}, Stand: 24.05.2021.

\end{thebibliography}